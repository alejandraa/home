#!/usr/bin/env ruby
#
# Install a flight of brews from a YAML file at ~/.flight.yml that has
# the following syntax:
#
#     taps:
#       - tubbo/homebrew-tap
#       - homebrew/homebrew-versions
#     packages:
#       - vim
#       - zsh
#       - postgresql93
#
# To invoke, run the following command in your console:
#
#     brew flight
#
# This will install all of the packages and taps you lay out in your
# YAML file.

require 'yaml'

config = YAML::load_file File.expand_path('~/.flight.yml')
taps = `brew tap`.split "\n"
packages = `brew list`.split "\s"
@error_code = 1

config['taps'].each do |tap|
  `brew tap #{tap} -q` unless taps.include? tap
  puts "Fetching packages from '#{tap}'..."
end

puts "Fetching packages from 'homebrew/homebrew'..."

`brew update -q`

success = config['packages'].all? do |package|
  if packages.include?(package)
    puts "Using #{package}"
    true
  else
    puts "Installing #{package}..."
    `brew install #{package} -q`
    unless $?.success?
      puts "Couldn't install #{package}!"
      @error_code = $?.to_i
    end
    $?.success?
  end
end

code = if success
  puts 'Your flight has been installed!'
  0
else
  puts 'There were errors installing your flight.'
  @error_code
end

exit code
